## 核心组件解析

### 1. **sandboxes (共享 Map)** - 第258行
```258:258:packages/orchestrator/main.go
sandboxes := sandbox.NewSandboxesMap()
```
**作用**：沙箱管理中心
- 存储所有活跃沙箱的状态映射
- 在 `server` 和 `proxy` 之间共享，用于传播沙箱路由信息
- 用于快速查找和管理运行中的沙箱实例

### 2. **featureFlags** - 第261-265行
```261:265:packages/orchestrator/main.go
featureFlags, err := featureflags.NewClient()
if err != nil {
	zap.L().Fatal("failed to create feature flags client", zap.Error(err))
}
closers = append(closers, closer{"feature flags", featureFlags.Close})
```
**作用**：功能开关管理

- 动态控制功能的开启/关闭
- 支持灰度发布和 A/B 测试
- 无需重启服务即可调整功能

### 3. **limiter** - 第268-272行
```268:272:packages/orchestrator/main.go
limiter, err := limit.New(ctx, featureFlags)
if err != nil {
	zap.L().Fatal("failed to create limiter", zap.Error(err))
}
closers = append(closers, closer{"limiter", limiter.Close})
```
**作用**：GCP（ Google 提供的云计算服务平台） 并发上传限制器

- 控制并发上传到 GCP 的请求数量
- 防止资源耗尽和配额超限
- 保护后端存储服务

### 4. **persistence (存储)** - 第274-277行
```274:277:packages/orchestrator/main.go
persistence, err := storage.GetTemplateStorageProvider(ctx, limiter)
if err != nil {
	zap.L().Fatal("failed to create template storage provider", zap.Error(err))
}
```
**作用**：模板持久化存储
- 负责模板的存储和检索
- 配合 limiter 控制上传速率

### 5. **blockMetrics** - 第279-282行
```279:282:packages/orchestrator/main.go
blockMetrics, err := blockmetrics.NewMetrics(tel.MeterProvider)
if err != nil {
	zap.L().Fatal("failed to create metrics provider", zap.Error(err))
}
```
**作用**：块设备性能监控

- 收集沙箱块设备（磁盘）的性能指标
- 监控 I/O 操作、延迟等指标
- 用于性能分析和故障排查

### 6. **templateCache** - 第284-287行
```284:287:packages/orchestrator/main.go
templateCache, err := template.NewCache(ctx, config, featureFlags, persistence, blockMetrics)
if err != nil {
	zap.L().Fatal("failed to create template cache", zap.Error(err))
}
```
**作用**：模板缓存管理

- 缓存沙箱模板，加速沙箱创建
- 从 `persistence` 加载模板到本地
- 依赖 `blockMetrics` 监控缓存性能
- 减少重复下载，提升响应速度

### 7. **clickhouse** - 第292-305行
```292:305:packages/orchestrator/main.go
if config.ClickhouseConnectionString != "" {
	clickhouseConn, err := clickhouse.NewDriver(config.ClickhouseConnectionString)
	if err != nil {
		zap.L().Fatal("failed to create clickhouse driver", zap.Error(err))
	}

	sbxEventsDeliveryClickhouse, err := clickhouseevents.NewDefaultClickhouseSandboxEventsDelivery(ctx, clickhouseConn, featureFlags)
	if err != nil {
		zap.L().Fatal("failed to create clickhouse events delivery", zap.Error(err))
	}

	sbxEventsDeliveryTargets = append(sbxEventsDeliveryTargets, sbxEventsDeliveryClickhouse)
	closers = append(closers, closer{"sandbox events delivery for clickhouse", sbxEventsDeliveryClickhouse.Close})
}
```
**作用**：事件分析数据库

- 收集沙箱事件数据（创建、销毁、资源使用等）
- 用于数据分析和报表生成
- 支持高性能 OLAP 查询

### 8. **redis** - 第308-326行
```308:326:packages/orchestrator/main.go
redisClient, err := sharedFactories.NewRedisClient(ctx, sharedFactories.RedisConfig{
	RedisURL:         config.RedisURL,
	RedisClusterURL:  config.RedisClusterURL,
	RedisTLSCABase64: config.RedisTLSCABase64,
})
if err != nil && !errors.Is(err, sharedFactories.ErrRedisDisabled) {
	zap.L().Fatal("Could not connect to Redis", zap.Error(err))
} else if err == nil {
	closers = append(closers, closer{"redis client", func(context.Context) error {
		return sharedFactories.CloseCleanly(redisClient)
	}})
}

// Redis sandbox events delivery target
if redisClient != nil {
	sbxEventsDeliveryRedis := event.NewRedisStreamsDelivery[event.SandboxEvent](redisClient, event.SandboxEventsStreamName)
	sbxEventsDeliveryTargets = append(sbxEventsDeliveryTargets, sbxEventsDeliveryRedis)
	closers = append(closers, closer{"sandbox events delivery for redis", sbxEventsDeliveryRedis.Close})
}
```
**作用**：分布式缓存和事件流
- 通过 Redis Streams 实时分发沙箱事件
- 支持跨节点数据共享和缓存
- 实现服务间通信和状态同步

### 9. **sandboxObserver** - 第329-333行
```329:333:packages/orchestrator/main.go
sandboxObserver, err := metrics.NewSandboxObserver(ctx, nodeID, serviceName, commitSHA, version, serviceInstanceID, sandboxes)
if err != nil {
	zap.L().Fatal("failed to create sandbox observer", zap.Error(err))
}
closers = append(closers, closer{"sandbox observer", sandboxObserver.Close})
```
**作用**：沙箱状态监控器
- 定期观察 `sandboxes` map 中的沙箱状态
- 收集和上报沙箱数量、健康状态等指标
- 用于监控告警和容量规划

### 10. **serviceInfo** - 第150行
```150:150:packages/orchestrator/main.go
serviceInfo := service.NewInfoContainer(nodeID, version, commitSHA, serviceInstanceID, config)
```
**作用**：服务元信息容器
- 存储服务的基本信息（节点ID、版本号、提交SHA、实例ID等）
- 管理服务状态（Healthy、Draining、Unhealthy）
- 用于健康检查和服务发现
- 在优雅关闭时协调服务状态切换

### 11. **telemetry (tel)** - 第167-177行
```167:177:packages/orchestrator/main.go
tel, err := telemetry.New(ctx, nodeID, serviceName, commitSHA, version, serviceInstanceID)
if err != nil {
	zap.L().Fatal("failed to init telemetry", zap.Error(err))
}
defer func() {
	err := tel.Shutdown(ctx)
	if err != nil {
		log.Printf("error while shutting down telemetry: %v", err)
		success = false
	}
}()
```
**作用**：可观测性基础设施（遥测）

- 提供 **LogsProvider**：日志收集和导出（OTEL日志）
- 提供 **MeterProvider**：指标收集和监控（Prometheus格式）
- 提供 **TracesProvider**：分布式追踪（链路追踪）
- 集成 OpenTelemetry，统一可观测性数据收集
- 支持导出到多种后端（如 Grafana、Jaeger等）

## 核心服务组件依赖表

### sandboxProxy
#### 组件依赖
[sandboxes](#1-sandboxes-共享-map---第258行), [telemetry](#11-telemetry-tel---第167-177行).MeterProvider



### devicePool

#### 组件依赖
无依赖



### networkPool

#### 组件依赖
[redis](#8-redis---第308-326行)(生产环境/通过slotStorage), 或内存存储(开发环境)



### sandboxFactory

#### 组件依赖
[networkPool](#networkpool), [devicePool](#devicepool), [featureFlags](#2-featureflags---第261-265行)



### orchestratorService

**[接口执行流程图](./CmuxServer/grpc/sandbox/sandboxservice.drawio)**

#### 组件依赖
[sandboxes](#1-sandboxes-共享-map---第258行), [featureFlags](#2-featureflags---第261-265行), [persistence](#4-persistence-存储---第274-277行), [templateCache](#6-templatecache---第284-287行), [clickhouse](#7-clickhouse---第292-305行)(事件), [redis](#8-redis---第308-326行)(事件), [sandboxFactory](#sandboxfactory), [sandboxProxy](#sandboxproxy), [networkPool](#networkpool), [devicePool](#devicepool), [serviceInfo](#10-serviceinfo---第150行), [telemetry](#11-telemetry-tel---第167-177行)



### hyperloopSrv

**[hyperloop server 端点](./HyperloopServer/endpoints.md)**

#### 组件依赖
[sandboxes](#1-sandboxes-共享-map---第258行)



### templateService

**[接口执行流程图](./CmuxServer/grpc/sandbox/sandboxservice.drawio)**

#### 组件依赖
[sandboxes](#1-sandboxes-共享-map---第258行), [featureFlags](#2-featureflags---第261-265行), [limiter](#3-limiter---第268-272行), [persistence](#4-persistence-存储---第274-277行), [templateCache](#6-templatecache---第284-287行), [sandboxFactory](#sandboxfactory), [sandboxProxy](#sandboxproxy), [serviceInfo](#10-serviceinfo---第150行), [telemetry](#11-telemetry-tel---第167-177行).MeterProvider



### infoService

#### 组件依赖
[sandboxes](#1-sandboxes-共享-map---第258行), [serviceInfo](#10-serviceinfo---第150行)



### grpcHealth

#### 组件依赖
无依赖



### grpcServer

#### 组件依赖
[telemetry](#11-telemetry-tel---第167-177行), [orchestratorService](#orchestratorservice), [templateService](#templateservice)(可选), [infoService](#infoservice), [grpcHealth](#grpchealth)



### httpServer

#### 组件依赖
[serviceInfo](#10-serviceinfo---第150行)(健康检查用)

