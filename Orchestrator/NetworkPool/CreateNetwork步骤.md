## ğŸ“‹ ç½‘ç»œåˆ›å»ºæ­¥éª¤æ€»ç»“

### è¡¥å……çŸ¥è¯†

[ç½‘ç»œæ ¸å¿ƒæ¦‚å¿µ]: ./ç½‘ç»œæ ¸å¿ƒæ¦‚å¿µ.md

### ç¬¬ä¸€æ­¥ï¼šé”å®šå½“å‰çº¿ç¨‹

[ä¸ºä»€ä¹ˆè¦é”å®šOSçº¿ç¨‹?]: ./goé”å®šOSçº¿ç¨‹.md

```go
runtime.LockOSThread()
defer runtime.UnlockOSThread()
```

### ç¬¬äºŒæ­¥ï¼šä¿å­˜å½“å‰å‘½åç©ºé—´

```go
hostNS, err := netns.Get()
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ–°çš„ç½‘ç»œå‘½åç©ºé—´

```go
ns, err := netns.NewNamed(s.NamespaceID())
```

### ç¬¬å››æ­¥ï¼šåˆ›å»º Veth å¯¹

```go
veth := &netlink.Veth{
    LinkAttrs: vethAttrs,
    PeerName:  s.VpeerName(),
}
```

### ç¬¬äº”æ­¥ï¼šåœ¨ä¸»æœºç«¯é…ç½® Veth

```go
err = netlink.LinkSetNsFd(veth, int(hostNS))
```

### ç¬¬å…­æ­¥ï¼šåˆ›å»º TAP è®¾å¤‡

```go
tap := &netlink.Tuntap{
    Mode:      netlink.TUNTAP_MODE_TAP,
    LinkAttrs: tapAttrs,
}
```

### ç¬¬ä¸ƒæ­¥ï¼šå¯åŠ¨å›ç¯è®¾å¤‡

```go
lo, err := netlink.LinkByName(loopbackInterface)
err = netlink.LinkSetUp(lo)
```

### ç¬¬å…«æ­¥ï¼šé…ç½®è·¯ç”±

```go
err = netlink.RouteAdd(&netlink.Route{
    Scope: netlink.SCOPE_UNIVERSE,
    Gw:    s.VethIP(),
})
```

### ç¬¬ä¹æ­¥ï¼šé…ç½® NAT è§„åˆ™

```go
tables.Append("nat", "POSTROUTING", ..., "SNAT", ...)
tables.Append("nat", "PREROUTING", ..., "DNAT", ...)
```

### ç¬¬åæ­¥ï¼šé…ç½®ä¸»æœºç«¯è·¯ç”±å’Œé˜²ç«å¢™

```go
netlink.RouteAdd(...)                       // æ·»åŠ åˆ°æ²™ç®±çš„è·¯ç”±
tables.Append("filter", "FORWARD", ...)     // å…è®¸æµé‡è½¬å‘
tables.Append("nat", "POSTROUTING", ...)    // ä¼ªè£…å‡ºç«™æµé‡
```

### ç¬¬åä¸€æ­¥ï¼šé…ç½® Hyperloop ä»£ç†

```go
tables.Append("nat", "PREROUTING", ..., "REDIRECT", ...)
```

---

[å…­æ¡iptablesä½œç”¨]: iptables.md



## ğŸŒ ç½‘ç»œæ¶æ„å›¾

```
ä¸»æœºç½‘ç»œå‘½åç©ºé—´                æ²™ç®±ç½‘ç»œå‘½åç©ºé—´
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚                â”‚             â”‚
â”‚   [veth] â—„â”€â”€â”¼â”€â”€â”€â”€è™šæ‹Ÿç½‘çº¿â”€â”€â”€â”€â”¼â”€â”€â–º [vpeer]  â”‚
â”‚      â†•      â”‚                â”‚      â†•      â”‚
â”‚  [è·¯ç”±è¡¨]    â”‚                â”‚   [tap]     â”‚
â”‚  [iptables] â”‚                â”‚      â†•      â”‚
â”‚      â†•      â”‚                â”‚ [Firecracker]â”‚
â”‚  [å¤–éƒ¨ç½‘ç»œ]  â”‚                â”‚   [æ²™ç®±åº”ç”¨] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å®Œæ•´çš„æ•°æ®æµç¤ºä¾‹

å‡è®¾æ²™ç®±å†…åº”ç”¨è®¿é—® `google.com`ï¼š

```
1. æ²™ç®±åº”ç”¨: å‘é€åŒ… [æº:10.0.0.2 â†’ ç›®æ ‡:142.250.217.46:443]
   â†“
2. é»˜è®¤è·¯ç”±: é€šè¿‡ç½‘å…³ veth (è§„åˆ™8è®¾ç½®çš„)
   â†“
3. SNAT è§„åˆ™1: [æº:172.16.0.1 â†’ ç›®æ ‡:142.250.217.46:443]
   â†“
4. è½¬å‘è§„åˆ™3: å…è®¸é€šè¿‡
   â†“
5. MASQUERADE è§„åˆ™5: [æº:å®¿ä¸»å…¬ç½‘IP â†’ ç›®æ ‡:142.250.217.46:443]
   â†“
6. å‘å¾€äº’è”ç½‘
   â†“
7. å“åº”è¿”å›: [æº:142.250.217.46:443 â†’ ç›®æ ‡:å®¿ä¸»å…¬ç½‘IP]
   â†“
8. è‡ªåŠ¨åå‘ NAT: [æº:142.250.217.46:443 â†’ ç›®æ ‡:10.0.0.2]
   â†“
9. æ²™ç®±åº”ç”¨æ”¶åˆ°å“åº” âœ…
```
