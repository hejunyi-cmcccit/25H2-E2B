# Linux文件系统

## **1. 根文件系统 (Rootfs)**

**根文件系统**是Linux系统的基础，包含操作系统运行所需的所有文件：

```
/
├── bin/        # 基本命令（如 ls, cp）
├── etc/        # 系统配置文件
├── lib/        # 共享库
├── usr/        # 用户程序
├── var/        # 可变数据（日志等）
├── home/       # 用户目录
└── ...
```

在这段代码中，`rootfs.ext4` 就是一个**完整的根文件系统镜像文件**，从Docker镜像转换而来。

## **2. ext4 文件系统**

ext4 是Linux最常用的文件系统格式，类似Windows的NTFS。这段代码中：
- 将Docker镜像转换成 **ext4格式的镜像文件**
- 这个文件可以像硬盘一样被挂载和使用

```bash
# 类似于：
dd if=/dev/zero of=disk.img bs=1M count=1024  # 创建1GB文件
mkfs.ext4 disk.img                            # 格式化为ext4
mount disk.img /mnt                           # 挂载使用
```

# 沙箱文件系统

## **模板Overlay**

### 流程

#### 创建流程

```go
// 创建与模板文件同样大小的稀疏文件
err = f.Truncate(size)
// 使用mmap将稀疏文件映射到内存，加快读写
mm, err := mmap.MapRegion(f, int(size), unix.PROT_READ|unix.PROT_WRITE, 0, 0)
```

#### 读写流程

```go
// overlay.go - 读操作
func (o *Overlay) ReadAt(ctx context.Context, p []byte, off int64) (int, error) {
    // 1. 先尝试从缓存读（沙箱的修改）
    n, err := o.cache.ReadAt(p, off)
    if err == nil {
        return n, nil  // ✓ 从缓存读取（很少的数据）
    }
    
    // 2. 缓存没有，从只读模板读（大部分数据）
    n, err = o.device.ReadAt(ctx, p, off)  // ✓ 从模板读取
    return n, err
}

// overlay.go - 写操作
func (o *Overlay) WriteAt(p []byte, off int64) (int, error) {
    // 所有写入只去缓存
    return o.cache.WriteAt(p, off)  // ✓ 只写入少量修改
}
```



### 好处

#### 节省空间

```
只读模板: 2GB (所有沙箱共享) → 磁盘占用 2GB

沙箱 1 缓存: 稀疏文件 (声称 2GB)
  ├─ 实际写入: 50MB
  └─ 磁盘占用: 50MB
  
...

沙箱 100 缓存: 稀疏文件 (声称 2GB)
  ├─ 实际写入: 30MB
  └─ 磁盘占用: 30MB

总磁盘占用: 2GB (模板) + 6GB (所有缓存) = 8GB
```

#### 读取、写入性能很高

```
读取优先级:

// 虽然稀疏文件的随机读取稍慢，但mmap缓存弥补了这点
// 并且由于是稀疏文件，占内存空间较小
1. 沙箱 mmap 缓存 (稀疏文件) 
   └─ 命中: 0.001ms (最快)
   └─ 未命中: ↓
   
// Linux 会自动将读取过的文件数据缓存在内存中：
2. Linux 页面缓存 (模板)
   └─ 命中: 0.01ms (很快，95%的情况)
   └─ 未命中: ↓

3. 磁盘 (SSD/NVMe)
   └─ 5-15ms (只有第一次)

写入： 只写cache而不写模板，由于mmap所以是在写内存
```

